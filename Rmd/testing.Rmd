---
title: "testing the module"
author: "Jeffrey Walker"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# wrangling packages
library(here) # here makes a project transportable
library(janitor) # clean_names
library(readxl) # read excel, duh!
library(data.table) # magical data frames
library(magrittr) # pipes
library(stringr) # string functions
library(forcats) # factor functions

# analysis packages
library(emmeans) # the workhorse for inference
library(nlme) # gls and some lmm
library(lme4) # linear mixed models
library(lmerTest) # linear mixed model inference
library(afex) # ANOVA linear models
library(glmmTMB) # generalized linear models
library(MASS) # negative binomial and some other functions
library(car) # model checking and ANOVA
library(DHARMa) # model checking
library(mvtnorm)
library(MHTdiscrete) # sidak

# graphing packages
library(ggsci) # color palettes
library(ggpubr) # publication quality plots
library(ggforce) # better jitter
library(cowplot) # combine plots
library(knitr) # kable tables
library(kableExtra) # kable_styling tables

# ggplot_the_model.R packages not loaded above
library(insight)
library(lazyWeave)

# use here from the here package
here <- here::here
# use clean_names from the janitor package
clean_names <- janitor::clean_names
# use transpose from data.table
transpose <- data.table::transpose

# load functions used by this text written by me
# ggplot_the_model.R needs to be in the folder "R"
# if you didn't download this and add to your R folder in your
# project, then this line will cause an error
source_path <- here("R", "ggplot_the_model.R")
source(source_path)

data_folder <- "data"
image_folder <- "images"
output_folder <- "output"
```

```{r import_data}
file_path <- here(data_folder, "fig3g.xlsx")
fig3 <- read_xlsx(file_path) |>
    data.table()
```



```{r}
m1 <- lm(ucp1 ~ tx * surgery, data = fig3)
m1_emm <- emmeans(m1, specs = c("tx", "surgery"))
m1_all <- contrast(m1_emm,
                     method = "revpairwise",
                     adjust = "none") |>
    summary(infer = TRUE)
m1_simple <- contrast(m1_emm,
                     method = "revpairwise",
                     adjust = "none",
                     simple = "each") |>
    summary(infer = TRUE)

m1_emm
m1_all
m1_simple
```

# CRD - 2 x 2 (Twoway ANOVA)

```{r fake-2x2-crd}
seed <- 1
fake_data <- simulator(
  seed_i = seed,
  n_sim = 1,
  n_treat = 4, # number of treatment levels
  n_block = 1, # number of litters (blocks)
  n_rep = 6, # number of mice per litter:treatment
  n_ss = 1, # number of subsamples
  n_exp = 1, # number of experiments
  design = "pseudoreplicated",
  correlated_slopes = FALSE, # TRUE uses random int/slope model to generate data
  beta = c(2400, -800, -700, -1200),
  sigma_exp.block = 0, # only sampling 1 litter
  sigma_rep = 400, # among mouse variance
  sigma_ss = 0, # among technical reps within mouse
  block_name = "litter",
  rep_name = "mouse",
  ss_name = "ss"
)
setnames(fake_data, c("treatment", "sim_1"), c("fake_treatment", "csa")) # cross-sectional area
fake_data[fake_treatment == "Cn", treatment := "Intact\nLONP1"]
fake_data[fake_treatment == "Tr1", treatment := "Denerv\nLONP1"]
fake_data[fake_treatment == "Tr2", treatment := "Intact\nmKO"]
fake_data[fake_treatment == "Tr3", treatment := "Denerv\nmKO"]
fake_data[, c("surgery", "genotype") := tstrsplit(treatment, "\n")]
fake_data[, treatment := factor(treatment, levels = c("Intact\nLONP1", "Denerv\nLONP1", "Intact\nmKO", "Denerv\nmKO"))]
m1 <- lm(csa ~ treatment, data = fake_data)
m1_emm <- emmeans(m1, specs = "treatment")
m1_pairs <- contrast(m1_emm,
                     method = "revpairwise")
ggplot_the_response(m1, m1_emm, m1_pairs, dots = "sina", jitter_width = 0.5)
ggplot_the_response(m1, m1_emm, m1_pairs, dots = "jitter", jitter_width = 0.2)

fake_data[, surgery := factor(surgery, levels = c("Intact", "Denerv"))]
fake_data[, genotype := factor(genotype, levels = c("LONP1", "mKO"))]
m1 <- lm(csa ~ surgery * genotype, data = fake_data)
m1_emm <- emmeans(m1, specs = c("surgery", "genotype"))
m1_pairs <- contrast(m1_emm,
                     method = "revpairwise",
                     adjust = "none") |>
  summary(infer = TRUE)
m1_pairs <- contrast(m1_emm,
                     method = "revpairwise",
                     simple = "each",
                     combine = TRUE,
                     adjust = "none") |>
  summary(infer = TRUE)


```


# CRDS - 2 x 1 (Nested)

Here the response is myotube diameter. 80 myotubes per mouse were measured. See fig5h

```{r fake-crds}
seed <- 1
# sigma_e^2 = sigma_rep^2 + sigma_ss^2
# icc = sigma_rep^2 / sigma_e^2
icc <- 0.6
sigma_e <- 2
sigma_rep <- sqrt(icc*sigma_e^2)
sigma_ss <- sqrt(sigma_e^2 - sigma_rep^2)
fake_data <- simulator(
  seed_i = seed,
  n_sim = 1,
  n_treat = 2, # number of treatment levels
  n_block = 1, # number of litters (blocks)
  n_rep = 6, # number of mice per litter:treatment
  n_ss = 80, # number of subsamples
  n_exp = 1, # number of experiments
  design = "pseudoreplicated",
  correlated_slopes = FALSE, # TRUE uses random int/slope model to generate data
  beta = c(21, -3),
  sigma_exp.block = 0, # only sampling 1 litter
  sigma_rep = sigma_rep, # among mouse variance
  sigma_ss = sigma_ss, # among technical reps within mouse
  block_name = "litter",
  rep_name = "mouse",
  ss_name = "ss"
)
setnames(fake_data, c("ss", "sim_1"), c("technical_rep", "diameter")) # cross-sectional area
fake_data[, genotype := ifelse(treatment == "Cn", "Control", "mKO")]
fake_data[, genotype := factor(genotype, levels = c("Control", "mKO"))]
m1 <- lmer(diameter ~ genotype + (1|mouse), data = fake_data)
m1_emm <- emmeans(m1, specs = "genotype")
m1_pairs <- contrast(m1_emm,
                     method = "revpairwise")
ggplot_the_response(m1, m1_emm, m1_pairs)

```


# CRDS-gamma

```{r}

seed <- 1
# sigma_e^2 = sigma_rep^2 + sigma_ss^2
# icc = sigma_rep^2 / sigma_e^2
icc <- 0.4
sigma_e <- 10
sigma_rep <- sqrt(icc*sigma_e^2)
sigma_ss <- sqrt(sigma_e^2 - sigma_rep^2)
fake_data <- simulator(
  seed_i = seed,
  n_sim = 1,
  family = "gamma",
  n_treat = 2, # number of treatment levels
  n_block = 1, # number of litters (blocks)
  n_rep = 6, # number of mice per litter:treatment
  n_ss = 25, # number of subsamples
  n_exp = 1, # number of experiments
  design = "pseudoreplicated",
  correlated_slopes = FALSE, # TRUE uses random int/slope model to generate data
  beta = c(20, -5),
  sigma_exp.block = 0, # only sampling 1 litter
  sigma_rep = sigma_rep, # among mouse variance
  sigma_ss = sigma_ss, # among technical reps within mouse
  block_name = "litter",
  rep_name = "mouse",
  ss_name = "ss"
)
setnames(fake_data, c("ss", "sim_1"), c("technical_rep", "diameter")) # cross-sectional area
fake_data[, genotype := ifelse(treatment == "Cn", "Control", "mKO")]
fake_data[, genotype := factor(genotype, levels = c("Control", "mKO"))]
m1 <- glmer(diameter ~ genotype + (1 | mouse), 
            family = Gamma(link = "log"),
            data = fake_data)
m1_emm <- emmeans(m1, specs = "genotype", type = "response")
m1_pairs <- contrast(m1_emm,
                     method = "revpairwise") |>
  summary(infer = TRUE)
ggplot_the_response(m1, m1_emm, m1_pairs)

```


# RCBD - 2 x 2 (RM-ANOVA)

```{r rcbd-2x2}
seed <- 1
# sigma_e^2 = sigma_rep^2 + sigma_ss^2
# icc = sigma_rep^2 / sigma_e^2
icc <- 0.6
sigma_e <- 400
sigma_rep <- sqrt(icc*sigma_e^2)
sigma_ss <- sqrt(sigma_e^2 - sigma_rep^2)

fake_data <- simulator(
  seed_i = seed,
  n_sim = 1,
  n_treat = 4, # number of treatment levels
  n_block = 8, # number of litters (blocks)
  n_rep = 1, # number of mice per litter:treatment
  n_ss = 1, # number of subsamples
  n_exp = 1, # number of experiments
  design = "rcbd",
  correlated_slopes = FALSE, # TRUE uses random int/slope model to generate data
  beta = c(2400, -800, -700, -1200),
  sigma_exp.block = sigma_rep, # sd among exp:block (or block if n_exp = 1). This is among mouse
  sigma_exp.block.treat = 100, # sd among exp:block:treat
  sigma_ss = sigma_ss, # sd among subsamples within replication of treatment:block
  block_name = "litter",
  rep_name = "mouse",
  ss_name = "ss"
)

setnames(fake_data, c("treatment", "sim_1"), c("fake_treatment", "csa")) # cross-sectional area
fake_data[fake_treatment == "Cn", treatment := "Intact LONP1"]
fake_data[fake_treatment == "Tr1", treatment := "Denerv LONP1"]
fake_data[fake_treatment == "Tr2", treatment := "Intact mKO"]
fake_data[fake_treatment == "Tr3", treatment := "Denerv mKO"]
fake_data[, c("surgery", "genotype") := tstrsplit(treatment, " ")]
m1 <- lmer(csa ~ surgery * genotype + (1 | litter), data = fake_data)
m1_emm <- emmeans(m1, specs = c("surgery", "genotype"))
m1_pairs <- contrast(m1_emm,
                     method = "revpairwise",
                     simple = "each",
                     combine = "TRUE") |>
  summary(infer = TRUE)
m1_pairs <- contrast(m1_emm,
                     method = "revpairwise",
                     simple = "each") |>
  summary(infer = TRUE)
m1_pairs <- contrast(m1_emm,
                     method = "pairwise",
                     simple = "each",
                     combine = "TRUE") |>
  summary(infer = TRUE)

ggplot_the_response(m1, m1_emm, m1_pairs)
m1_emm
m1_pairs

```



